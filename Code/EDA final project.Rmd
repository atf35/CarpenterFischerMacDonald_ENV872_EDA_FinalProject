---
output:
  pdf_document: 
    keep_tex: yes
    fig_caption: yes
    number_sections: yes
    toc: yes
geometry: margin=2.54cm
title: "Seasonal Salt Content, in the Neuse River"
subtitle: "Web address for GitHub repository"
author: "Atalie Fischer, Kathlyn MacDonald, Jack Carpenter"
fontsize: 12pt
mainfont: Times New Roman
  
---

\newpage
\tableofcontents 
\newpage
\listoftables 
\newpage
\listoffigures 
\newpage

```{r setup, include=FALSE}
knitr::opts_chunk$set(include = FALSE)
# Set your working directory
# setwd("/Users/kmac9/OneDrive/Documents/Duke/Year 1/Spring 2022/ENV Data/CarpenterFischerMacDonald_ENV872_EDA_FinalProject/")
# setwd("/Users/ataliefischer/Desktop/EDA/CarpenterFischerMacDonald_ENV872_EDA_FinalProject/")
getwd()

#install.packages("fable")
#install.packages("tseries")

# Load packages
library(tidyverse)
library(lubridate)
library(trend)
library(forecast)
library(dataRetrieval)
library(sf)
library(maps)
library(knitr)
library(nhdplusTools)
library(cowplot)
#library(fable)
library(tseries)

# Set ggplot theme
mytheme <- theme_classic(base_size = 10) +
  theme(axis.text = element_text(color = "black"), 
        legend.position = "top")

## Load datasets

#load water quality data for the Neuse River at Kinston, NC
NeuseWQ <- readWQPqw(siteNumbers = "USGS-02089500", # Neuse River at Kinston, NC
                     parameterCd = c("00915", # calcium, filtered mg/L
                                     "00925", # magnesium, filtered mg/L
                                     "00930", # sodium,filtered mg/L
                                     "90095"),  # Specific conductance, uS/cm
                     startDate = "1976-01-01",
                     endDate = "")
write.csv(NeuseWQ, row.names = TRUE, file = "../Data/Raw/NeuseWQ_raw.csv")

#load discharge data for Neuse River at Kinston, NC
NeuseFlow <- readNWISdv(siteNumbers = "02089500", # Neuse River at Kinston, NC
                     parameterCd = "00060", # discharge (cfs)
                     startDate = "1976-01-01",
                     endDate = "")
write.csv(NeuseFlow, row.names = TRUE, file = "../Data/Raw/NeuseFlow_raw.csv")
```

# Rationale and Research Questions (Kathlyn)
The maintenance of healthy and functioning water systems is critical not just to human life, but also to the survival of countless other species and their interconnected ecosystems. We are only beginning to understand the impact of human action on water bodies. Conductivity, or the ability of water to pass an electrical current via dissolved salts and other minerals, is a strong indicator of water quality. Changes in conductivity over time suggest a potential pollutant entering the system. 

For this study, we chose to analyze how specific conductance can vary depending on the season. In particular, we wanted to address the impact of winterizing the roadways with salt on water quality. Our main research question was: is salting the roads a main driver in changes to water conductivity, or are other  minerals a significant factor? Here, we chose to analyze the Neuse River in Kinston, North Carolina over a 46 year period (1976-2022) (???, check on this bc of the NAs). We chose this river due to familiarity with the data and its proximity to an urban center (Kinston pop = 20,398). ADD MORE!

We used the following research questions to guide our work: 
> 1. How does specific conductance vary seasonally? 
> 2. Is calcium, magnesium, or sodium the driver of specific conductance?
> 3. What is the likely specific conductance in the future (forcasting trends)?


\newpage

# Dataset Information (Jack)

Neuse River water quality and discharge data at Kinston, North Carolina. The gage information comes from the United States Geologic Survey (USGS) National Water Information Systems (NWIS) database. USGS gage stations typically collect discharge, and a subset collect water quality data as well. This water quality data may include nutrient concentrations, concentrations of chlorophyll a, specific conductivity, and concentrations of certain ions. Since seasonal salinity trends and their potential sources are the focus of this study, the water quality data being examined includes specific conductivity and concentrations of calcium, magnesium, and sodium in the water column. Specific conductivity will be used as a proxy for salinization, and the relative amounts of each salt ion will be examined in the hopes of identifying a potential source of any seasonal salinity increases, in particular the contribution of road salts to salinization. 

To obtain both sets of data, we used the dataRetrieval package to connect directly to the NWIS database and pull water quality and discharge data without needing to download it first. Both sets of data are pulled starting in 1976, and end at the most recent data point in the database in 2022. 

Dataset           | Info
------------------|------------------------
NeuseWQ           | Water quality data collected at USGS gage 02089500
NeuseFlow         | Discharge data collected at USGS gage 02089500


\newpage

# Exploratory Analysis (Atalie)

```{r Map of Neuse Watershed, eval=FALSE, include=FALSE}

####need to fix this...

plot_nhdplus("USGS-02089500", streamorder = 3) 
```


The first step we took in our initial exploratory analysis was to wrangle the water quality (WQ) dataset to include only the columns of interest. This included the sampling dates and concentrations for specific conductance, calcium (Ca), sodium (Na), and magnesium (Mg), which were each given separate columns. This dataset contains monthly observations, however, not necessarily sampled on the first of each month. We wrangled the WQ dataset to round the dates to the first of the month to ensure that there are evenly spaced time steps across the years, a necessary condition for time series analyses. 

```{r WQ wrangling, include=FALSE}
# select columns of interest
NeuseWQ_processed <- NeuseWQ %>%
  select(ActivityStartDate, HydrologicCondition, CharacteristicName, ResultMeasureValue) %>%
  mutate(Variable = case_when(CharacteristicName == "Calcium" ~ "Ca_mg.L",
                              CharacteristicName == "Magnesium" ~ "Mg_mg.L",
                              CharacteristicName == "Sodium" ~ "Na_mg.L",
                              CharacteristicName == "Specific conductance" ~ "SpC_uS.cm")) %>%
  select(-CharacteristicName) %>%
  pivot_wider(names_from = "Variable", values_from = "ResultMeasureValue") 

# create sequence of dates with even time steps 
Months <- data.frame(Date_monthrounded = seq.Date(from = as.Date("1976-01-01"), to = as.Date("2022-12-01"), by = "month"))

# round sample dates down to the first of the month to ensure even time steps
NeuseWQ_processed <- NeuseWQ_processed %>% 
  mutate(Year = year(ActivityStartDate),
         Month = month(ActivityStartDate),
         Date_monthrounded = floor_date(ActivityStartDate, "month")) %>% # round date
  arrange(ActivityStartDate)

# join the WQ and months together to find gaps in data
NeuseWQ_monthly <- left_join(Months, NeuseWQ_processed)

# average months to consolidate months with multiple observations
NeuseWQ_monthly <- NeuseWQ_monthly %>% 
  group_by(Date_monthrounded) %>% 
  summarise(AvgCa_mg.L = mean(Ca_mg.L),
            AvgMg_mg.L = mean(Mg_mg.L),
            AvgNa_mg.L = mean(Na_mg.L),
            AvgSpC_uS.cm = mean(SpC_uS.cm))


# write csv file for WQ data
write.csv(NeuseWQ_processed, row.names = TRUE, file = "./Data/Processed/NeuseWQ_processed.csv")
write.csv(NeuseWQ_monthly, row.names = TRUE, file = "./Data/Processed/NeuseWQ_monthly.csv")
```

We plotted the specific conductance over time to visualize any gaps in our dataset. We see that the WQ dataset contains many long periods of missing data for specific conductance. Since these missing periods frequently span across many years, we chose to look at WQ data from 2013 through 2021. There are no missing data points from this period of time, and we will therefore not require any interpolation of this dataset. 

```{r Visualize monthly WQ data, echo=FALSE, fig.align='left', fig.cap="Specific Conductance in the Neuse River", warning=FALSE, include=TRUE}
ggplot(NeuseWQ_monthly) +
  geom_line(aes(x = Date_monthrounded, y = AvgSpC_uS.cm)) +
  labs(x = "Date", y = expression("Specific Conductance ("*mu*"S/cm)"))
```

```{r Visualize 2013-2021 WQ data (Conductance), include=TRUE, echo=FALSE, warning=FALSE, fig.align='left', fig.cap="Specific Conductance in the Neuse River from 2013 through 2021."}
NeuseWQ_short <- NeuseWQ_monthly %>% 
  filter(Date_monthrounded >= "2013-01-01" & Date_monthrounded < "2022-01-01")

ggplot(NeuseWQ_short) +
  geom_line(aes(x = Date_monthrounded, y = AvgSpC_uS.cm)) +
  labs(x = "Date", y = expression("Specific Conductance ("*mu*"S/cm)"))
```

```{r Water Quality Dataset Summary, include=TRUE, echo=FALSE}
summary(NeuseWQ_short)
```

We are also interested in the flow of the Neuse River because this factor may affect salinity. For example, higher discharges may dilute any salinity and drier periods may reflect higher salt content. We started by wrangling the flow dataset to include the parameters of interest, sampling date and discharge. 

```{r Flow wrangling, include=FALSE}
# flow dataset
NeuseFlow_processed <- NeuseFlow %>%
  select(ActivityStartDate = Date, discharge_cfs = X_00060_00003) %>% 
  filter(ActivityStartDate >= "2013-01-01" & ActivityStartDate <= "2022-01-01") %>% 
  mutate(Year = year(ActivityStartDate),
         Month = month(ActivityStartDate))

## check even time steps
Days <- data.frame(Days = seq.Date(from = as.Date("2013-01-01"), to = as.Date("2022-01-01"), by = "day"))
NeuseFlow_days <- left_join(Days, NeuseFlow_processed, by = c("Days" = "ActivityStartDate"))
summary(NeuseFlow_days) # no NA's in dataset

# write files to csv
write.csv(NeuseFlow_processed, row.names = TRUE, file = "./Data/Processed/NeuseFlow_processed.csv")
write.csv(NeuseFlow_days, row.names = TRUE, file = "./Data/Processed/NeuseFlow_days.csv")
```

```{r Discharge summary, include=TRUE, echo=FALSE, message=FALSE}
summary(NeuseFlow_processed) #no NAs in the dataset
```

```{r Discharge over time, include=TRUE, echo=FALSE, message=FALSE, fig.align='left', fig.cap="Discharge in the Neuse River from 2013 through 2021."}
ggplot(NeuseFlow_processed) +
  geom_line(aes(x = ActivityStartDate, y = discharge_cfs)) +
  labs(x = "Date", y = "Discharge (cfs)") +
  scale_y_log10()
```

\newpage

# Analysis

## Question 1: How does specific conductance vary seasonally?
After running the the MannKendall test for seasonality, we have determined that for the Nuese river there is no significant in seasonality for conductivity (p = 0.25276). However, we can conclude seasonality in flow data, discharge varies significantly depending on the season (p = 3.368e-07).

Measure           | P-value
------------------|------------------------
Conductivity      | 0.25276
Calcium           | 0.1038
Magnesium         | 0.29151
Sodium            | 0.091911
Discharge         | 3.368e-07

```{r Conductivity time series and decomp, include=FALSE}
#Creating Time Series for conductivity
NeuseCond_ts <- ts(NeuseWQ_short[[5]], frequency = 12)
NeuseCond_decomp <- stl(NeuseCond_ts, s.window = "periodic")
```

```{r Plot of Conductivity Time Series Decomp, include=TRUE, echo=FALSE, message=FALSE, fig.align='left', fig.cap="Time Series Decomposition of Conductivity in the Neuse River."}
plot(NeuseCond_decomp)
```

```{r Salt time series and decomps, include=FALSE}
#Decomposing by Mineral
#Calcium
NeuseCond_Calcium_ts <- ts(NeuseWQ_short$AvgCa_mg.L, frequency = 12)
NeuseCond_Calcium_decomp <- stl(NeuseCond_Calcium_ts, s.window = "periodic")

#Magnesium
NeuseCond_magnesium_ts <- ts(NeuseWQ_short$AvgMg_mg.L, frequency = 12)
NeuseCond_magneisum_decomp <- stl(NeuseCond_magnesium_ts, s.window = "periodic")

#Sodium
NeuseCond_sodium_ts <- ts(NeuseWQ_short$AvgNa_mg.L, frequency = 12)
NeuseCond_sodium_decomp <- stl(NeuseCond_sodium_ts, s.window = "periodic")
```

```{r Plot of Calcium Time Series Decomp, include=TRUE, echo=FALSE, message=FALSE, fig.align='left', fig.cap="Time Series Decomposition of Calcium in the Neuse River."}
plot(NeuseCond_Calcium_decomp, main = "Calcium")
```

```{r Plot of Magnesium Time Series Decomp, include=TRUE, echo=FALSE, message=FALSE, fig.align='left', fig.cap="Time Series Decomposition of Magnesium in the Neuse River."}
plot(NeuseCond_magneisum_decomp, main = "Magnesium")
```

```{r Plot of Sodium Time Series Decomp, include=TRUE, echo=FALSE, message=FALSE, fig.align='left', fig.cap="Time Series Decomposition of Sodium in the Neuse River."}
plot(NeuseCond_sodium_decomp, main = "Sodium")
```

```{r Discharge time series and decomp, include=FALSE}
#Creating Time Series for flow data
NeuseFlow_ts <- ts(NeuseFlow_processed[[2]], frequency =365)
NeuseFlow_decomp <- stl(NeuseFlow_ts, s.window = "periodic")
```

```{r Plot of Discharge Time Series Decomposition, include=TRUE, echo=FALSE, message=FALSE, fig.align='left', fig.cap="Time Series Decomposition of Discharge in the Neuse River."}
plot(NeuseFlow_decomp)
```

```{r Testing for Seasonality, include=TRUE, echo=FALSE, message=FALSE}
#Conductivity
Neuse_seasonality_trends_Conductivity <- Kendall::SeasonalMannKendall(NeuseCond_ts)
Neuse_seasonality_trends_Conductivity
summary(Neuse_seasonality_trends_Conductivity)

#Calcium
Neuse_seasonality_trends_Conductivity_Ca <- Kendall::SeasonalMannKendall(NeuseCond_Calcium_ts)
Neuse_seasonality_trends_Conductivity_Ca
summary(Neuse_seasonality_trends_Conductivity_Ca)

#Magnesium
Neuse_seasonality_trends_Conductivity_Mg <- Kendall::SeasonalMannKendall(NeuseCond_magnesium_ts)
Neuse_seasonality_trends_Conductivity_Mg
summary(Neuse_seasonality_trends_Conductivity_Mg)

#Sodium
Neuse_seasonality_trends_Conductivity_Na <- Kendall::SeasonalMannKendall(NeuseCond_sodium_ts)
Neuse_seasonality_trends_Conductivity_Na
summary(Neuse_seasonality_trends_Conductivity_Na)


#Testing for seasonality within Flow data
Neuse_seasonality_trends_Flow <- Kendall::SeasonalMannKendall(NeuseFlow_ts)
Neuse_seasonality_trends_Flow
summary(Neuse_seasonality_trends_Flow)
```


## Question 2: Is calcium, magnesium, or sodium the driver of specific conductance?


```{r Visualize 2013-2021 Conductivity, include=TRUE, echo=FALSE, message=FALSE, fig.align='left', fig.cap="Conductivity in the Neuse River from 2013 through 2021."}
#plot sodium over same shorter time period
ggplot(NeuseWQ_short) +
  geom_line(aes(x = Date_monthrounded, y = AvgSpC_uS.cm)) +
  labs(x = "Date", y = expression("Specific Conductivity"))
```

```{r Visualize 2013-2021 WQ data, include=FALSE}
#plot calcium over same shorter time period as specific conductivity
Ca.plot <- ggplot(NeuseWQ_short) +
  geom_line(aes(x = Date_monthrounded, y = AvgCa_mg.L)) +
  labs(x = "", y = expression("Calcium (mg/L)"))

#plot Mg over same shorter time period
Mg.plot <- ggplot(NeuseWQ_short) +
  geom_line(aes(x = Date_monthrounded, y = AvgMg_mg.L)) +
  labs(x = "", y = expression("Magnesium (mg/L"))
Mg.plot

#plot sodium over same shorter time period
Na.plot <- ggplot(NeuseWQ_short) +
  geom_line(aes(x = Date_monthrounded, y = AvgNa_mg.L)) +
  labs(x = "Date", y = expression("Sodium (mg/L)"))
Na.plot

```

```{r Visualise all three components together, include=TRUE, echo=FALSE, message=FALSE, fig.align='left', fig.cap="Calcium, Magnesium, and Sodium in the Neuse River from 2013 through 2021"}
#now lets look at all three salt ions over the same time period
plot_grid(Ca.plot, Mg.plot, Na.plot,
          ncol = 1,
          align = "hv")
```

```{r Visualise salts and conductivity, include=TRUE, echo=FALSE, message=FALSE, fig.align='left', fig.cap="Specific Conductivity and salts in the Neuse River from 2013 through 2021"}
#plot spec cond and the salts on the same plot to look for patterns
ggplot(NeuseWQ_short) +
  geom_line(aes(x = Date_monthrounded, y = AvgSpC_uS.cm)) +
  geom_line(aes(x = Date_monthrounded, y = AvgCa_mg.L), color="red") +
  geom_line(aes(x = Date_monthrounded, y = AvgMg_mg.L), color="blue") +
  geom_line(aes(x = Date_monthrounded, y = AvgNa_mg.L), color="yellow3") +
  labs(x = "Date", y = "Concentration", color = "Variable")
```


##Question 3: <What is the likely specific conductance in the future (forcasting trends)?>



```{r eval=FALSE, include=FALSE}
#IN PROGRESS, not complete
#####i set this chunk to not run when knitting until its completed (-atalie)

#test for stationary, if p<0.05, the data is stationary (& we can run ARMA)

adf.test(NeuseCond_ts)

#Test for autocorrelation

forecast::Acf(NeuseCond_ts, type = "correlation", plot = TRUE, calc.ci= TRUE)

forecast::Pacf(NeuseCond_ts)

#attempt to forecast scenario
Conductivity_forecast <- forecast::forecast(NeuseCond_ts)

plot(Conductivity_forecast %>%
     labs(title = "Forecasts from ETS (A,N,N)"), x = "")


```




```{r STRAIGHT FROM WDA, eval=FALSE, include=FALSE}
# Recall there are a lot of parameters measured at the site
NeuseParams <- whatNWISdata(siteNumbers = "02089500")

# Extract latitude and longitude for the site
NeuseCoords <- NeuseParams %>%
  select(site_no, dec_lat_va, dec_long_va) %>%
  distinct() #include only distinct rows in dataframe (consolidate repeats)

# Define the gage site as the starting point
start_point <- st_sfc(st_point(c(NeuseCoords$dec_long_va, NeuseCoords$dec_lat_va)), #convert lat/long coordinates into spatial data
                      crs = 4269) # NAD83, commonly  used by US agencies
start_comid <- discover_nhdplus_id(start_point) #ask for ID of site using coordinates 
# start_point2 <- st_as_sf(data.frame(x = NeuseCoords$dec_long_va, y =  NeuseCoords$dec_lat_va), 
#                             coords = c("x", "y"), crs = 4269)

# Navigate the NLDI network
NLDI <- navigate_nldi(list(featureSource = "comid", featureID = start_comid), #create origin dataset and flow lines (define upstream flowing down to the station point)
                          mode = "upstreamTributaries", 
                          distance_km = 1000)

# Extract watershed and flowpath information
subset_file <- tempfile(fileext = ".gpkg") #must use temp file to use subset function below
subset <- subset_nhdplus(comids = as.integer(NLDI$UT$nhdplus_comid), #match with start_comid
                         output_file = subset_file, 
                         nhdplus_data = "download", 
                         flowline_only = FALSE,
                         return_data = TRUE, overwrite = TRUE) #overwrite temporary file 

# Create data frames
flowline <- subset$NHDFlowline_Network #streams and rivers within the defined network (dendritic pattern) (line segments)
catchment <- subset$CatchmentSP #0/1 inlet, 1 outlet. no specific flowlines in, but flowline out. (polygon)
waterbody <- subset$NHDWaterbody #anything other than a stream (polygon)

class(flowline) #spatial features, tables, dataframes
class(catchment)
class(waterbody)

# find gages near watershed
gages <- get_nwis(AOI = catchment) #find other gages within the area of our catchment. can also define distance from a point as area of interest. 
class(gages)

# find gages only within watershed
gages <- st_intersection(gages, catchment) #create dataset including only gages that intersect with catchement of interest. warning reminding that it should be in same projection. 







plot_nhdplus("USGS-02089500", streamorder = 3) #specify minimum stream order you want to show. don't need to do all the stuff before. this is the Neuse River at Kinston (prepackaged) 


states <- st_as_sf(map(database = "state", plot = FALSE, fill = TRUE, col = "white"))
nc <- filter(states, ID == "north carolina")

ggplot(nc) +
  geom_sf(fill = "white") +
  geom_sf(data = flowline, aes(color = streamorde)) +
  labs(color = "Stream Order") +
  theme(legend.position = "top")

ggplot(catchment) +
  geom_sf(fill = "white", color = "gray", lwd = 0.5) +
  geom_sf(data = flowline, aes(color = streamorde)) +
  geom_sf(data = gages, color = "darkred", size = 1) +
  labs(color = "Stream Order") +
  theme(legend.position = "top")
```






\newpage

# Summary and Conclusions


\newpage

# References
<add references here if relevant, otherwise delete this section> 
